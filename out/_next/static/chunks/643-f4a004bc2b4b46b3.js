"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[643],{20858:(e,t,r)=>{r.d(t,{M:()=>o});var s=r(12115),a=r(42099);let o=()=>{let[e,t]=(0,s.useState)([]),[r,o]=(0,s.useState)([]),[i,n]=(0,s.useState)([]),[l,c]=(0,s.useState)([]),[u,d]=(0,s.useState)([]),[_,S]=(0,s.useState)(!0),[E,h]=(0,s.useState)(null),f=async()=>{try{S(!0),h(null);let{data:e,error:r}=await a.ND.from("courses").select("*").order("name");if(r)throw r;let{data:s,error:i}=await a.ND.from("students").select("*").order("full_name");if(i)throw i;console.log("\uD83D\uDCCA Students fetched from Supabase:",null==s?void 0:s.map(e=>({id:e.id,name:e.full_name,status:e.status})));let{data:l,error:u}=await a.ND.from("authorized_persons").select("*").order("full_name");if(u)throw u;let{data:_,error:E}=await a.ND.from("pickup_logs").select("*").order("pickup_timestamp",{ascending:!1});if(E)throw E;let{data:f,error:w}=await a.ND.from("schedules").select("*").order("day_of_week, start_time");if(w)throw w;t(e||[]),o(s||[]),n(l||[]),c((_||[]).map(e=>({...e,pickup_timestamp:new Date(e.pickup_timestamp)}))),d(f||[]),(0,a.S_)("FETCH_ALL_DATA_SUCCESS",{courses:null==e?void 0:e.length,students:null==s?void 0:s.length,persons:null==l?void 0:l.length,logs:null==_?void 0:_.length,schedules:null==f?void 0:f.length})}catch(e){h(e instanceof Error?e.message:"Unknown error occurred"),(0,a.S_)("FETCH_ALL_DATA_ERROR",null,e)}finally{S(!1)}},w=async e=>{try{let r={id:Date.now().toString(),...e},{data:s,error:o}=await a.ND.from("courses").insert(r).select().single();if(o)throw o;return t(e=>[...e,s]),(0,a.S_)("ADD_COURSE_SUCCESS",{courseId:s.id}),s}catch(e){throw(0,a.S_)("ADD_COURSE_ERROR",null,e),e}},m=async(e,r)=>{try{let{data:s,error:o}=await a.ND.from("courses").update(r).eq("id",e).select().single();if(o)throw o;t(t=>t.map(t=>t.id===e?{...t,...s}:t)),(0,a.S_)("UPDATE_COURSE_SUCCESS",{courseId:e})}catch(e){throw(0,a.S_)("UPDATE_COURSE_ERROR",null,e),e}},D=async e=>{try{let{error:r}=await a.ND.from("courses").delete().eq("id",e);if(r)throw r;t(t=>t.filter(t=>t.id!==e)),(0,a.S_)("DELETE_COURSE_SUCCESS",{courseId:e})}catch(e){throw(0,a.S_)("DELETE_COURSE_ERROR",null,e),e}},R=async e=>{try{let t={id:Date.now().toString(),...e,status:"Presente"},{data:r,error:s}=await a.ND.from("students").insert(t).select().single();if(s)throw s;o(e=>[...e,r]),(0,a.S_)("ADD_STUDENT_SUCCESS",{studentId:r.id})}catch(e){throw(0,a.S_)("ADD_STUDENT_ERROR",null,e),e}},p=async(e,t)=>{try{console.log("\uD83D\uDD04 Updating student:",e,"with data:",t);let{data:r,error:s}=await a.ND.from("students").update(t).eq("id",e).select().single();if(s)throw s;o(t=>{let s=t.map(t=>t.id===e?{...t,...r}:t);return console.log("✅ Student updated in state:",s.find(t=>t.id===e)),s}),(0,a.S_)("UPDATE_STUDENT_SUCCESS",{studentId:e})}catch(e){throw(0,a.S_)("UPDATE_STUDENT_ERROR",null,e),e}},U=async e=>{try{let{error:t}=await a.ND.from("students").delete().eq("id",e);if(t)throw t;o(t=>t.filter(t=>t.id!==e)),(0,a.S_)("DELETE_STUDENT_SUCCESS",{studentId:e})}catch(e){throw(0,a.S_)("DELETE_STUDENT_ERROR",null,e),e}},C=async e=>{try{let t={id:Date.now().toString(),...e},{data:r,error:s}=await a.ND.from("authorized_persons").insert(t).select().single();if(s)throw s;n(e=>[...e,r]),(0,a.S_)("ADD_AUTHORIZED_PERSON_SUCCESS",{personId:r.id})}catch(e){throw(0,a.S_)("ADD_AUTHORIZED_PERSON_ERROR",null,e),e}},g=async(e,t)=>{try{let{data:r,error:s}=await a.ND.from("authorized_persons").update(t).eq("id",e).select().single();if(s)throw s;n(t=>t.map(t=>t.id===e?{...t,...r}:t)),(0,a.S_)("UPDATE_AUTHORIZED_PERSON_SUCCESS",{personId:e})}catch(e){throw(0,a.S_)("UPDATE_AUTHORIZED_PERSON_ERROR",null,e),e}},y=async e=>{try{let{error:t}=await a.ND.from("authorized_persons").delete().eq("id",e);if(t)throw t;n(t=>t.filter(t=>t.id!==e)),(0,a.S_)("DELETE_AUTHORIZED_PERSON_SUCCESS",{personId:e})}catch(e){throw(0,a.S_)("DELETE_AUTHORIZED_PERSON_ERROR",null,e),e}},T=async(e,t,r)=>{try{let{data:s,error:o}=await a.ND.from("pickup_logs").insert({student_id:e,authorized_person_id:t,recorded_by_user:r,pickup_timestamp:new Date().toISOString()}).select().single();if(o)throw o;console.log("\uD83D\uDCDD Setting student status to Retirado for student:",e),await p(e,{status:"Retirado"});let i={...s,pickup_timestamp:new Date(s.pickup_timestamp)};c(e=>[i,...e]),(0,a.S_)("REGISTER_PICKUP_SUCCESS",{studentId:e,authorizedPersonId:t})}catch(e){throw(0,a.S_)("REGISTER_PICKUP_ERROR",null,e),e}},A=async e=>{try{let{data:t,error:r}=await a.ND.from("schedules").insert(e).select().single();if(r)throw r;d(e=>[...e,t]),(0,a.S_)("ADD_SCHEDULE_SUCCESS",{scheduleId:t.id})}catch(e){throw(0,a.S_)("ADD_SCHEDULE_ERROR",null,e),e}},I=async(e,t)=>{try{let{data:r,error:s}=await a.ND.from("schedules").update(t).eq("id",e).select().single();if(s)throw s;d(t=>t.map(t=>t.id===e?r:t)),(0,a.S_)("UPDATE_SCHEDULE_SUCCESS",{scheduleId:e})}catch(e){throw(0,a.S_)("UPDATE_SCHEDULE_ERROR",null,e),e}},N=async e=>{try{let{error:t}=await a.ND.from("schedules").delete().eq("id",e);if(t)throw t;d(t=>t.filter(t=>t.id!==e)),(0,a.S_)("DELETE_SCHEDULE_SUCCESS",{scheduleId:e})}catch(e){throw(0,a.S_)("DELETE_SCHEDULE_ERROR",null,e),e}},O=async()=>{try{console.log("\uD83D\uDD04 RESET_DAILY_STATUS called - Current students before reset:",r.map(e=>({id:e.id,name:e.full_name,status:e.status})));let{error:e}=await a.ND.from("students").update({status:"Presente"}).neq("status","Presente");if(e)throw e;o(e=>{let t=e.map(e=>({...e,status:"Presente"}));return console.log("✅ Students updated to Presente:",t.map(e=>({id:e.id,name:e.full_name,status:e.status}))),t}),(0,a.S_)("RESET_DAILY_STATUS_SUCCESS")}catch(e){throw console.error("❌ Error in resetDailyStatus:",e),(0,a.S_)("RESET_DAILY_STATUS_ERROR",null,e),e}},P=r.map(t=>({...t,course:e.find(e=>e.id===t.course_id)}));return(0,s.useEffect)(()=>{f()},[]),{courses:e,students:r,authorizedPersons:i,pickupLogs:l,schedules:u,studentsWithCourses:P,loading:_,error:E,addCourse:w,updateCourse:m,deleteCourse:D,addStudent:R,updateStudent:p,deleteStudent:U,getStudentWithAuthorizedPersons:t=>{let s=r.find(e=>e.id===t);if(!s)return null;let a=e.find(e=>e.id===s.course_id),o=i.filter(e=>e.student_id===t);return{...s,course:a,authorizedPersons:o}},addAuthorizedPerson:C,updateAuthorizedPerson:g,deleteAuthorizedPerson:y,getAuthorizedPersonsByStudent:e=>i.filter(t=>t.student_id===e),registerPickup:T,addSchedule:A,updateSchedule:I,deleteSchedule:N,getSchedulesByCourse:e=>u.filter(t=>t.course_id===e),getSchedulesByDay:e=>u.filter(t=>t.day_of_week===e),resetDailyStatus:O,searchStudents:e=>{let t=e.toLowerCase();return P.filter(e=>e.full_name.toLowerCase().includes(t)||e.course.name.toLowerCase().includes(t))},refetch:f}}},40283:(e,t,r)=>{r.d(t,{A:()=>n,AuthProvider:()=>l});var s=r(95155),a=r(12115),o=r(42099);let i=(0,a.createContext)(void 0),n=()=>{let e=(0,a.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e},l=e=>{let{children:t}=e,[r,n]=(0,a.useState)(null),[l,c]=(0,a.useState)(!1),[u,d]=(0,a.useState)(null);(0,a.useEffect)(()=>{let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);n(t)}catch(e){localStorage.removeItem("user")}},[]);let _=async(e,t)=>{try{let{data:r,error:s}=await o.ND.from("students").select("id, full_name, rut_passport").eq("rut_passport",e).single();if(s||!r)throw Error("RUT no encontrado en el sistema");let a=(e=>{let t=e.replace(/[.\-\s]/g,"");return t.length>=5?t.slice(-5,-1):t.slice(0,-1)})(e);if(t!==a)throw Error("Contrase\xf1a incorrecta");return{id:"parent_".concat(r.id),email:e,name:"Apoderado de ".concat(r.full_name),role:"Parent",subject:void 0,is_active:!0}}catch(e){throw console.error("Parent authentication error:",e),Error("Credenciales incorrectas")}},S=async(e,t)=>{try{let{data:r,error:s}=await o.ND.from("users").select("id, email, name, role, subject, is_active, created_at, updated_at").eq("email",e).eq("password_hash",t).eq("is_active",!0).single();if(s||!r)throw Error("Credenciales incorrectas");return r}catch(e){throw console.error("Authentication error:",e),Error("Credenciales incorrectas")}},E=async(e,t)=>{c(!0),d(null);try{await new Promise(e=>setTimeout(e,1e3));let r=await S(e,t);if(!r)throw Error("Credenciales incorrectas");let s={id:r.id,email:r.email,name:r.name,role:r.role,subject:r.subject,is_active:r.is_active};n(s),localStorage.setItem("user",JSON.stringify(s))}catch(e){throw d(e instanceof Error?e.message:"Error de autenticaci\xf3n"),e}finally{c(!1)}},h=async(e,t)=>{c(!0),d(null);try{await new Promise(e=>setTimeout(e,1e3));let r=await _(e,t);if(!r)throw Error("Credenciales incorrectas");n(r),localStorage.setItem("user",JSON.stringify(r))}catch(e){throw d(e instanceof Error?e.message:"Error de autenticaci\xf3n"),e}finally{c(!1)}};return(0,s.jsx)(i.Provider,{value:{user:r,login:E,loginAsParent:h,logout:()=>{n(null),localStorage.removeItem("user"),d(null)},isLoading:l,error:u},children:t})}},42099:(e,t,r)=>{r.d(t,{ND:()=>l,S_:()=>c});var s=r(55647),a=r(49509);let o="https://dpqjjmrhqwwjlpgvqgve.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwcWpqbXJocXd3amxwZ3ZxZ3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzY5NzgsImV4cCI6MjA2ODk1Mjk3OH0.177ogvUMAiFUbJ_Oyy6Bm0R-EoqVIRU5cTbzLKoj_mk",n=a.env.SUPABASE_SERVICE_ROLE_KEY;if(!o)throw Error("Missing environment variable: NEXT_PUBLIC_SUPABASE_URL");if(!i)throw Error("Missing environment variable: NEXT_PUBLIC_SUPABASE_ANON_KEY");console.log("\uD83D\uDD17 Supabase Config:",{url:o,hasAnonKey:!!i,hasServiceKey:!!n});let l=(0,s.UU)(o,i);n&&(0,s.UU)(o,n,{auth:{autoRefreshToken:!1,persistSession:!1}});let c=(e,t,r)=>{let s=new Date().toISOString();console.log("[SUPABASE ".concat(s,"] ").concat(e),{data:t?JSON.stringify(t,null,2):void 0,error:r?r instanceof Error?r.message:String(r):void 0})}}}]);